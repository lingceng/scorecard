<!DOCTYPE html>

<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>打牌计分器</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0c0c18;
  --surface: #151526;
  --surface2: #1c1c34;
  --text: #eaeaea;
  --text-dim: #6b7394;
  --accent: #e94560;
  --red: #e94560;
  --green: #2ecc71;
  --border: rgba(255,255,255,0.05);
  --radius: 16px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Noto Sans SC',sans-serif;background:var(--bg);color:var(--text);min-height:100dvh;overflow-x:hidden;padding:env(safe-area-inset-top) 0 env(safe-area-inset-bottom)}
.container{max-width:420px;margin:0 auto;padding:12px 10px 100px}

/* Header */
.header{text-align:center;padding:8px 0 12px}
.header h1{font-size:14px;font-weight:700;letter-spacing:4px;color:var(–text-dim);text-transform:uppercase}

/* ===== SCORE TABLE ===== */
.score-table{background:var(–surface);border-radius:var(–radius);border:1px solid var(–border);overflow:hidden}

.table-header{
display:grid;grid-template-columns:1fr auto;
padding:8px 14px;font-size:11px;color:var(–text-dim);
font-weight:500;letter-spacing:1.5px;border-bottom:1px solid var(–border);
}

.player-row{
display:grid;grid-template-columns:1fr auto;
align-items:center;padding:8px 10px 8px 12px;
border-bottom:1px solid var(–border);
min-height:76px;transition:background 0.4s;
}
.player-row:last-child{border-bottom:none}
.player-row.auto-highlighted{background:rgba(233,69,96,0.04)}
.player-row.auto-highlighted .wheel-indicator{
border-color:rgba(233,69,96,0.35);box-shadow:0 0 12px rgba(233,69,96,0.1);
}

/* Left: avatar + total grouped tight */
.player-left{display:flex;align-items:center;gap:12px}

.avatar{
width:48px;height:48px;border-radius:13px;
display:flex;align-items:center;justify-content:center;
font-family:‘DM Mono’,monospace;font-size:22px;font-weight:500;
cursor:pointer;transition:transform 0.15s;color:#fff;flex-shrink:0;
box-shadow:0 3px 12px rgba(0,0,0,0.35);
}
.avatar:active{transform:scale(0.92)}
.avatar.p0{background:linear-gradient(140deg,#ff6b81,#c0392b)}
.avatar.p1{background:linear-gradient(140deg,#54a0ff,#2471a3)}
.avatar.p2{background:linear-gradient(140deg,#5fd68d,#27ae60)}
.avatar.p3{background:linear-gradient(140deg,#feca57,#d68910)}

.total-score{
font-family:‘DM Mono’,monospace;font-size:34px;font-weight:500;
line-height:1;transition:color 0.3s;min-width:40px;
}
.total-score.positive{color:var(–red)}
.total-score.negative{color:var(–green)}
.total-score.zero{color:var(–text-dim)}

/* Right: wheel */
.wheel-cell{display:flex;justify-content:center;align-items:center}
.wheel-container{
width:56px;height:100px;position:relative;overflow:hidden;
cursor:grab;touch-action:none;
}
.wheel-track{
position:absolute;width:100%;left:0;
transition:transform 0.3s cubic-bezier(0.22,1,0.36,1);
}
.wheel-item{
height:34px;display:flex;align-items:center;justify-content:center;
font-family:‘DM Mono’,monospace;font-size:18px;font-weight:500;
opacity:0.15;transition:opacity 0.2s,transform 0.2s;user-select:none;
}
.wheel-item.active{opacity:1;transform:scale(1.15)}
.wheel-item.adjacent{opacity:0.35}
.wheel-container::before,.wheel-container::after{
content:’’;position:absolute;left:0;right:0;height:33px;z-index:2;pointer-events:none;
}
.wheel-container::before{top:0;background:linear-gradient(to bottom,var(–surface),transparent)}
.wheel-container::after{bottom:0;background:linear-gradient(to top,var(–surface),transparent)}
.player-row.auto-highlighted .wheel-container::before{background:linear-gradient(to bottom,#1a1628,transparent)}
.player-row.auto-highlighted .wheel-container::after{background:linear-gradient(to top,#1a1628,transparent)}
.wheel-indicator{
position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
width:52px;height:34px;border-radius:8px;
border:1.5px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.02);
z-index:1;pointer-events:none;transition:border-color 0.4s,box-shadow 0.4s;
}

/* ===== SUBMIT ===== */
.submit-section{padding:14px 0 6px;position:relative}
.submit-btn{
width:100%;padding:16px;border:none;border-radius:var(–radius);
background:linear-gradient(135deg,var(–accent),#b8344a);
color:#fff;font-size:16px;font-weight:700;
font-family:‘Noto Sans SC’,sans-serif;cursor:pointer;
transition:transform 0.15s,opacity 0.15s;letter-spacing:2px;
box-shadow:0 4px 20px rgba(233,69,96,0.25);
position:relative;overflow:hidden;
}
.submit-btn:active{transform:scale(0.97);opacity:0.9}

/* Ripple on button */
.submit-btn .ripple{
position:absolute;border-radius:50%;background:rgba(255,255,255,0.35);
transform:scale(0);animation:rippleAnim 0.6s ease-out forwards;
pointer-events:none;
}
@keyframes rippleAnim{to{transform:scale(4);opacity:0}}

/* ===== CONFETTI CANVAS ===== */
#confettiCanvas{
position:fixed;top:0;left:0;width:100%;height:100%;
pointer-events:none;z-index:300;
}

/* ===== HISTORY ===== */
.history-section{margin-top:18px}
.history-title{
font-size:12px;color:var(–text-dim);font-weight:500;
letter-spacing:1.5px;margin-bottom:8px;
display:flex;align-items:center;justify-content:space-between;
}
.history-list{display:flex;flex-direction:column;gap:5px}
.history-item{
background:var(–surface);border-radius:10px;padding:9px 12px;
display:grid;grid-template-columns:32px 1fr auto;
align-items:center;gap:8px;border:1px solid var(–border);
}
.history-item.newest{animation:slideIn 0.35s ease}
@keyframes slideIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}

.history-round{font-family:‘DM Mono’,monospace;font-size:11px;color:var(–text-dim);text-align:center}
.history-scores{display:flex;gap:10px}
.history-score-item{
display:flex;align-items:center;gap:3px;
font-family:‘DM Mono’,monospace;font-size:13px;
}
.history-score-item .mini-avatar{
width:18px;height:18px;border-radius:5px;
display:flex;align-items:center;justify-content:center;
font-size:9px;color:#fff;font-family:‘DM Mono’,monospace;
}
.undo-btn{
background:none;border:1px solid rgba(233,69,96,0.25);color:var(–accent);
font-size:11px;padding:4px 10px;border-radius:6px;cursor:pointer;
font-family:‘Noto Sans SC’,sans-serif;transition:all 0.15s;
}
.undo-btn:active{background:rgba(233,69,96,0.08)}
.show-more-btn{
background:none;border:1px solid var(–border);color:var(–text-dim);
width:100%;padding:10px;border-radius:10px;font-size:12px;cursor:pointer;
font-family:‘Noto Sans SC’,sans-serif;margin-top:5px;
}
.no-history{text-align:center;color:var(–text-dim);font-size:13px;padding:18px;opacity:0.5}

/* New Game */
.new-game-section{margin-top:22px;padding-bottom:20px}
.new-game-btn{
width:100%;padding:14px;border:1.5px solid rgba(255,255,255,0.08);
border-radius:var(–radius);background:transparent;color:var(–text-dim);
font-size:14px;font-weight:500;font-family:‘Noto Sans SC’,sans-serif;
cursor:pointer;letter-spacing:1px;
}

/* Modals */
.modal-overlay{
position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:100;
display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(6px);
}
.modal-overlay.active{display:flex}
.modal-sheet{
background:var(–surface);border-radius:20px 20px 0 0;
width:100%;max-width:420px;padding:20px 16px 36px;animation:sheetUp 0.3s ease;
}
@keyframes sheetUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-title{font-size:15px;font-weight:700;text-align:center;margin-bottom:16px}
.letter-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
.letter-option{
aspect-ratio:1;border:none;border-radius:10px;
background:rgba(255,255,255,0.05);color:var(–text);
font-family:‘DM Mono’,monospace;font-size:18px;font-weight:500;
cursor:pointer;display:flex;align-items:center;justify-content:center;
}
.letter-option:active{transform:scale(0.92)}
.letter-option.taken{opacity:0.15;pointer-events:none}
.letter-option.current{background:var(–accent);color:#fff}
.modal-cancel{
width:100%;margin-top:14px;padding:12px;border:none;border-radius:10px;
background:rgba(255,255,255,0.05);color:var(–text-dim);font-size:14px;
font-family:‘Noto Sans SC’,sans-serif;cursor:pointer;
}

.confirm-modal{
position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:100;
display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px);
}
.confirm-modal.active{display:flex}
.confirm-box{
background:var(–surface);border-radius:var(–radius);
padding:24px 20px;width:300px;text-align:center;animation:popIn 0.25s ease;
}
@keyframes popIn{from{transform:scale(0.9);opacity:0}to{transform:scale(1);opacity:1}}
.confirm-box h3{font-size:17px;margin-bottom:8px}
.confirm-box p{font-size:13px;color:var(–text-dim);margin-bottom:20px;line-height:1.6}
.confirm-actions{display:flex;gap:10px}
.confirm-actions button{
flex:1;padding:12px;border:none;border-radius:10px;
font-size:14px;font-weight:500;cursor:pointer;font-family:‘Noto Sans SC’,sans-serif;
}
.confirm-no{background:rgba(255,255,255,0.06);color:var(–text)}
.confirm-yes{background:var(–accent);color:#fff}

.toast{
position:fixed;top:56px;left:50%;transform:translateX(-50%) translateY(-16px);
background:var(–surface2);color:var(–text);padding:10px 20px;
border-radius:10px;font-size:13px;font-weight:500;z-index:200;
opacity:0;transition:all 0.3s;pointer-events:none;border:1px solid var(–border);
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

.total-score.animating{animation:scorePulse 0.5s ease}
@keyframes scorePulse{0%{transform:scale(1)}50%{transform:scale(1.18)}100%{transform:scale(1)}}

/* Score flash overlay per row */
.score-flash{
position:absolute;inset:0;border-radius:var(–radius);
pointer-events:none;opacity:0;
}
.score-flash.positive{background:radial-gradient(ellipse at center,rgba(233,69,96,0.12),transparent 70%)}
.score-flash.negative{background:radial-gradient(ellipse at center,rgba(46,204,113,0.12),transparent 70%)}
.score-flash.show{animation:flashPulse 0.8s ease-out forwards}
@keyframes flashPulse{0%{opacity:1}100%{opacity:0}}
</style>

</head>
<body>
<div class="container">
  <div class="header"><h1>打牌计分器</h1></div>

  <div class="score-table">
    <div class="table-header"><span>玩家 / 总分</span><span>本轮得分</span></div>
    <div id="playerRows"></div>
  </div>

  <div class="submit-section">
    <button class="submit-btn" id="submitBtn" onclick="submitScores(event)">提交分数</button>
  </div>

  <div class="history-section">
    <div class="history-title"><span>历史轮次</span><span id="roundCount"></span></div>
    <div id="historyList" class="history-list"><div class="no-history">暂无记录</div></div>
    <button class="show-more-btn" id="showMoreBtn" style="display:none" onclick="toggleShowAll()">显示全部</button>
  </div>

  <div class="new-game-section">
    <button class="new-game-btn" onclick="confirmNewGame()">新开一局</button>
  </div>
</div>

<canvas id="confettiCanvas"></canvas>

<div class="modal-overlay" id="letterModal">
  <div class="modal-sheet">
    <div class="modal-title">选择字母</div>
    <div class="letter-grid" id="letterGrid"></div>
    <button class="modal-cancel" onclick="closeLetterModal()">取消</button>
  </div>
</div>

<div class="confirm-modal" id="confirmModal">
  <div class="confirm-box">
    <h3>新开一局</h3>
    <p>确定要清零所有分数吗？<br>玩家字母将保留。</p>
    <div class="confirm-actions">
      <button class="confirm-no" onclick="closeConfirm()">取消</button>
      <button class="confirm-yes" onclick="startNewGame()">确定</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const COLORS=['p0','p1','p2','p3'];
const BG_COLORS=[
  'linear-gradient(140deg,#ff6b81,#c0392b)',
  'linear-gradient(140deg,#54a0ff,#2471a3)',
  'linear-gradient(140deg,#5fd68d,#27ae60)',
  'linear-gradient(140deg,#feca57,#d68910)'
];

let players=JSON.parse(localStorage.getItem('cardPlayers'))||['A','B','C','D'];
let totals=[0,0,0,0],currentScores=[0,0,0,0],rounds=[];
let showAll=false,editingPlayer=-1;
let autoCalcIndex=-1,userTouched=[false,false,false,false],autoCalcLocked=false;

function init(){
  const s=localStorage.getItem('cardGameState');
  if(s){const d=JSON.parse(s);totals=d.totals||[0,0,0,0];rounds=d.rounds||[];}
  renderPlayers();renderHistory();
}
function saveState(){
  localStorage.setItem('cardPlayers',JSON.stringify(players));
  localStorage.setItem('cardGameState',JSON.stringify({totals,rounds}));
}

function renderPlayers(){
  const c=document.getElementById('playerRows');c.innerHTML='';
  for(let i=0;i<4;i++){
    const row=document.createElement('div');
    row.className='player-row';row.id=`row-${i}`;row.style.position='relative';

    // Left: avatar + total
    const left=document.createElement('div');left.className='player-left';
    const av=document.createElement('div');av.className=`avatar ${COLORS[i]}`;
    av.textContent=players[i];av.onclick=()=>openLetterModal(i);

    const td=document.createElement('div');
    td.className=`total-score ${totals[i]>0?'positive':totals[i]<0?'negative':'zero'}`;
    td.id=`total-${i}`;td.textContent=totals[i];

    left.appendChild(av);left.appendChild(td);

    // Flash overlay
    const flash=document.createElement('div');
    flash.className='score-flash';flash.id=`flash-${i}`;

    // Right: wheel
    const wc=document.createElement('div');wc.className='wheel-cell';
    const ww=document.createElement('div');ww.className='wheel-container';ww.id=`wheel-${i}`;
    const ind=document.createElement('div');ind.className='wheel-indicator';
    ww.appendChild(ind);
    const tk=document.createElement('div');tk.className='wheel-track';tk.id=`track-${i}`;
    for(let v=10;v>=-10;v--){
      const it=document.createElement('div');it.className='wheel-item';it.dataset.value=v;
      if(v>0){it.textContent=`+${v}`;it.style.color='var(--red)';}
      else if(v<0){it.textContent=`${v}`;it.style.color='var(--green)';}
      else{it.textContent='0';it.style.color='var(--text-dim)';}
      tk.appendChild(it);
    }
    ww.appendChild(tk);wc.appendChild(ww);

    row.appendChild(left);row.appendChild(wc);row.appendChild(flash);
    c.appendChild(row);
    setupWheel(i);setWheelValue(i,0,false);
  }
  resetAutoCalc();
}

const IH=34,TI=21;
function v2i(v){return 10-v}function i2v(i){return 10-i}

function setWheelValue(pi,value,anim=true){
  const tk=document.getElementById(`track-${pi}`);
  const ti=v2i(value),off=-(ti*IH)+IH;
  tk.style.transition=anim?'transform 0.3s cubic-bezier(0.22,1,0.36,1)':'none';
  tk.style.transform=`translateY(${off}px)`;
  currentScores[pi]=value;
  tk.querySelectorAll('.wheel-item').forEach((it,idx)=>{
    it.classList.remove('active','adjacent');
    if(idx===ti)it.classList.add('active');
    else if(Math.abs(idx-ti)===1)it.classList.add('adjacent');
  });
}

function setupWheel(pi){
  const wh=document.getElementById(`wheel-${pi}`);
  let sY=0,sO=0,drag=false,lY=0,vel=0,lT=0;
  function gO(){const t=document.getElementById(`track-${pi}`).style.transform;const m=t.match(/translateY\((.+?)px\)/);return m?parseFloat(m[1]):IH;}
  function onS(y){drag=true;sY=y;sO=gO();vel=0;lY=y;lT=Date.now();document.getElementById(`track-${pi}`).style.transition='none';}
  function onM(y){
    if(!drag)return;const n=Date.now(),dt=n-lT;if(dt>0)vel=(y-lY)/dt;lY=y;lT=n;
    const nO=sO+(y-sY),tk=document.getElementById(`track-${pi}`);
    tk.style.transform=`translateY(${nO}px)`;
    const ri=-(nO-IH)/IH,ni=Math.round(ri);
    tk.querySelectorAll('.wheel-item').forEach((it,idx)=>{
      it.classList.remove('active','adjacent');
      if(idx===ni)it.classList.add('active');
      else if(Math.abs(idx-ni)===1)it.classList.add('adjacent');
    });
  }
  function onE(){
    if(!drag)return;drag=false;
    const mom=vel*120,po=gO()+mom,ri=-(po-IH)/IH;
    let si=Math.round(ri);si=Math.max(0,Math.min(TI-1,si));
    setWheelValue(pi,i2v(si),true);
    userTouched[pi]=true;
    if(autoCalcIndex===pi){autoCalcLocked=true;autoCalcIndex=-1;document.querySelectorAll('.player-row').forEach(r=>r.classList.remove('auto-highlighted'));}
    if(!autoCalcLocked)checkAutoCalc();
  }
  wh.addEventListener('touchstart',e=>{e.preventDefault();onS(e.touches[0].clientY);},{passive:false});
  wh.addEventListener('touchmove',e=>{e.preventDefault();onM(e.touches[0].clientY);},{passive:false});
  wh.addEventListener('touchend',onE);
  wh.addEventListener('mousedown',e=>{
    e.preventDefault();onS(e.clientY);
    const mv=ev=>onM(ev.clientY);
    const up=()=>{onE();document.removeEventListener('mousemove',mv);document.removeEventListener('mouseup',up);};
    document.addEventListener('mousemove',mv);document.addEventListener('mouseup',up);
  });
}

function resetAutoCalc(){
  autoCalcIndex=-1;autoCalcLocked=false;userTouched=[false,false,false,false];
  document.querySelectorAll('.player-row').forEach(r=>r.classList.remove('auto-highlighted'));
}
function checkAutoCalc(){
  if(autoCalcLocked)return;
  if(autoCalcIndex!==-1){document.getElementById(`row-${autoCalcIndex}`).classList.remove('auto-highlighted');autoCalcIndex=-1;}
  const tc=userTouched.filter(Boolean).length;
  if(tc===3){
    const ui=userTouched.indexOf(false);if(ui===-1)return;
    const sum=currentScores.reduce((a,b)=>a+b,0);
    const av=currentScores[ui]-sum;
    if(av>=-10&&av<=10){
      autoCalcIndex=ui;setWheelValue(ui,av,true);
      document.getElementById(`row-${ui}`).classList.add('auto-highlighted');
    }
  }
}

// ===== SUBMIT with effects =====
function submitScores(e){
  const sum=currentScores.reduce((a,b)=>a+b,0);
  if(sum!==0){showToast(`分数之和不为0（当前 ${sum>0?'+':''}${sum}）`);return;}

  // Ripple effect on button
  if(e){
    const btn=document.getElementById('submitBtn');
    const rect=btn.getBoundingClientRect();
    const ripple=document.createElement('span');
    ripple.className='ripple';
    const size=Math.max(rect.width,rect.height);
    ripple.style.width=ripple.style.height=size+'px';
    ripple.style.left=(e.clientX||rect.left+rect.width/2)-rect.left-size/2+'px';
    ripple.style.top=(e.clientY||rect.top+rect.height/2)-rect.top-size/2+'px';
    btn.appendChild(ripple);
    setTimeout(()=>ripple.remove(),600);
  }

  // Record
  rounds.push([...currentScores]);

  // Flash + animate totals
  for(let i=0;i<4;i++){
    const old=totals[i];totals[i]+=currentScores[i];
    animateTotal(i,old,totals[i]);

    // Row flash
    const flash=document.getElementById(`flash-${i}`);
    flash.className='score-flash'+(currentScores[i]>=0?' positive':' negative');
    void flash.offsetWidth;
    flash.classList.add('show');
  }

  // Confetti!
  launchConfetti();

  // Reset wheels
  for(let i=0;i<4;i++)setWheelValue(i,0,true);
  resetAutoCalc();saveState();renderHistory();
}

function animateTotal(idx,from,to){
  const el=document.getElementById(`total-${idx}`);el.classList.add('animating');
  const dur=500,st=performance.now();
  function step(t){
    const p=Math.min((t-st)/dur,1),ease=1-Math.pow(1-p,3),c=Math.round(from+(to-from)*ease);
    el.textContent=c;el.className=`total-score animating ${c>0?'positive':c<0?'negative':'zero'}`;
    if(p<1)requestAnimationFrame(step);else el.classList.remove('animating');
  }
  requestAnimationFrame(step);
}

// ===== CONFETTI =====
function launchConfetti(){
  const canvas=document.getElementById('confettiCanvas');
  const ctx=canvas.getContext('2d');
  canvas.width=window.innerWidth;canvas.height=window.innerHeight;

  const colors=['#e94560','#54a0ff','#5fd68d','#feca57','#ff6b81','#a29bfe','#fd79a8'];
  const particles=[];
  const count=60;

  for(let i=0;i<count;i++){
    particles.push({
      x:canvas.width/2+(Math.random()-0.5)*200,
      y:canvas.height*0.45,
      vx:(Math.random()-0.5)*12,
      vy:-Math.random()*14-4,
      w:Math.random()*8+4,
      h:Math.random()*6+2,
      color:colors[Math.floor(Math.random()*colors.length)],
      rotation:Math.random()*360,
      rotSpeed:(Math.random()-0.5)*12,
      gravity:0.35,
      opacity:1,
      decay:0.008+Math.random()*0.008
    });
  }

  let raf;
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    let alive=false;
    for(const p of particles){
      if(p.opacity<=0)continue;
      alive=true;
      p.x+=p.vx;p.vy+=p.gravity;p.y+=p.vy;
      p.rotation+=p.rotSpeed;p.opacity-=p.decay;
      p.vx*=0.99;

      ctx.save();
      ctx.translate(p.x,p.y);
      ctx.rotate(p.rotation*Math.PI/180);
      ctx.globalAlpha=Math.max(0,p.opacity);
      ctx.fillStyle=p.color;
      ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
      ctx.restore();
    }
    if(alive)raf=requestAnimationFrame(draw);
    else ctx.clearRect(0,0,canvas.width,canvas.height);
  }
  draw();
}

// ===== HISTORY (newest first) =====
function renderHistory(){
  const c=document.getElementById('historyList'),cnt=document.getElementById('roundCount'),btn=document.getElementById('showMoreBtn');
  if(!rounds.length){c.innerHTML='<div class="no-history">暂无记录</div>';cnt.textContent='';btn.style.display='none';return;}
  cnt.textContent=`共 ${rounds.length} 轮`;

  // Show reversed (newest first), limit to 5 unless showAll
  const reversed=[...rounds].map((r,i)=>({round:r,idx:i})).reverse();
  const display=showAll?reversed:reversed.slice(0,5);
  c.innerHTML='';

  display.forEach((item,dispIdx)=>{
    const {round,idx:actualIdx}=item;
    const isNewest=actualIdx===rounds.length-1;

    const el=document.createElement('div');
    el.className='history-item'+(isNewest?' newest':'');

    const rn=document.createElement('div');rn.className='history-round';rn.textContent=`R${actualIdx+1}`;
    const sc=document.createElement('div');sc.className='history-scores';

    for(let i=0;i<4;i++){
      const s=document.createElement('div');s.className='history-score-item';
      const m=document.createElement('div');m.className='mini-avatar';m.style.background=BG_COLORS[i];m.textContent=players[i];
      const v=document.createElement('span');
      v.textContent=round[i]>0?`+${round[i]}`:round[i];
      v.style.color=round[i]>0?'var(--red)':round[i]<0?'var(--green)':'var(--text-dim)';
      s.appendChild(m);s.appendChild(v);sc.appendChild(s);
    }

    const ac=document.createElement('div');
    if(isNewest){
      const u=document.createElement('button');u.className='undo-btn';u.textContent='撤销';u.onclick=undoLast;ac.appendChild(u);
    }

    el.appendChild(rn);el.appendChild(sc);el.appendChild(ac);c.appendChild(el);
  });

  btn.style.display=rounds.length>5?'block':'none';
  btn.textContent=showAll?'收起':`显示全部（${rounds.length} 轮）`;
}
function toggleShowAll(){showAll=!showAll;renderHistory();}

function undoLast(){
  if(!rounds.length)return;const last=rounds.pop();
  for(let i=0;i<4;i++){const o=totals[i];totals[i]-=last[i];animateTotal(i,o,totals[i]);}
  saveState();renderHistory();showToast('已撤销上一轮');
}

// ===== LETTER PICKER =====
function openLetterModal(idx){
  editingPlayer=idx;const g=document.getElementById('letterGrid');g.innerHTML='';
  for(const ch of 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'){
    const b=document.createElement('button');b.className='letter-option';b.textContent=ch;
    if(players.findIndex((p,i)=>p===ch&&i!==idx)!==-1)b.classList.add('taken');
    if(players[idx]===ch)b.classList.add('current');
    b.onclick=()=>selectLetter(ch);g.appendChild(b);
  }
  document.getElementById('letterModal').classList.add('active');
}
function selectLetter(ch){players[editingPlayer]=ch;localStorage.setItem('cardPlayers',JSON.stringify(players));closeLetterModal();renderPlayers();renderHistory();}
function closeLetterModal(){document.getElementById('letterModal').classList.remove('active')}

function confirmNewGame(){document.getElementById('confirmModal').classList.add('active')}
function closeConfirm(){document.getElementById('confirmModal').classList.remove('active')}
function startNewGame(){
  closeConfirm();totals=[0,0,0,0];rounds=[];showAll=false;saveState();
  for(let i=0;i<4;i++){setWheelValue(i,0,true);const e=document.getElementById(`total-${i}`);e.textContent='0';e.className='total-score zero';}
  resetAutoCalc();renderHistory();showToast('新一局开始');
}

function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('show'),1800);}

document.getElementById('letterModal').addEventListener('click',e=>{if(e.target===e.currentTarget)closeLetterModal();});
document.getElementById('confirmModal').addEventListener('click',e=>{if(e.target===e.currentTarget)closeConfirm();});

init();
</script>

</body>
</html>
